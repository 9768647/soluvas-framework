<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0
        http://karaf.apache.org/xmlns/shell/v1.1.0 http://karaf.apache.org/xmlns/shell/v1.1.0">

	<reference-list id="subscriberSuppliers"
		interface="com.google.common.base.Supplier" availability="optional"
		filter="(type=eventbus)" />

	<bean id="svcLookup" class="org.soluvas.commons.tenant.MultitenantServiceLookup">
		<argument ref="blueprintBundleContext"/>
	</bean>
	<service ref="svcLookup" auto-export="interfaces"/>

	<command-bundle xmlns="http://karaf.apache.org/xmlns/shell/v1.1.0">
		<!-- EventBus -->
		<command name="eventbus/ls">
			<action class="org.soluvas.eventbus.EventBusLsCommand">
				<argument ref="subscriberSuppliers" />
			</action>
		</command>
		
		<command name="app/manifestcat">
			<action class="org.soluvas.commons.shell.AppManifestCatCommand">
				<argument ref="svcLookup" />
			</action>
		</command>
	</command-bundle>

	<bean class="org.soluvas.commons.EmfUnloader" destroy-method="destroy">
		<argument value="org.soluvas.commons.CommonsPackage" />
	</bean>

	<bean id="commonsPackage" class="org.soluvas.commons.impl.CommonsPackageImpl" factory-method="init" />
	<bean id="overlayingAppManifestSupplier" class="org.soluvas.commons.OverlayingSupplier">
		<argument>
			<bean class="org.soluvas.commons.impl.CommonsFactoryImpl" factory-method="init" />
		</argument>
		<argument>
			<bean factory-ref="commonsPackage" factory-method="getAppManifest" />
		</argument>
		<argument><list /></argument>
	</bean>
	<service ref="overlayingAppManifestSupplier" auto-export="interfaces">
		<service-properties>
			<entry key="clientId" value="berbatik" />
			<entry key="tenantId" value="berbatik" />
			<entry key="tenantEnv" value="dev" />
			<entry key="suppliedClass" value="org.soluvas.commons.AppManifest" />
			<entry key="layer" value="application" />
		</service-properties>
	</service>
	
	<bean id="appManifestSupplierTracker" class="org.soluvas.commons.SupplierTracker">
		<argument ref="blueprintBundleContext" />
		<argument ref="overlayingAppManifestSupplier" />
	</bean>
	<bean class="org.osgi.util.tracker.ServiceTracker" init-method="open" destroy-method="close">
		<argument ref="blueprintBundleContext" />
		<argument>
			<bean class="org.osgi.framework.FrameworkUtil" factory-method="createFilter">
				<argument value="(&amp;(objectClass=com.google.common.base.Supplier)(suppliedClass=org.soluvas.commons.AppManifest)(tenantId=berbatik)(tenantEnv=dev)(layer=module))" />
			</bean>
		</argument>
		<argument ref="appManifestSupplierTracker" />
	</bean>	

	<bean id="appManifestXmiTracker" class="org.soluvas.commons.XmiTracker">
		<argument ref="commonsPackage" />
		<argument value="org.soluvas.commons.AppManifest" />
		<argument value="berbatik" />
		<argument value="dev" />
	</bean>
	<bean class="org.osgi.util.tracker.BundleTracker" init-method="open" destroy-method="close">
		<argument ref="blueprintBundleContext" />
		<argument value="32" />
		<argument ref="appManifestXmiTracker" />
	</bean>

</blueprint>
