<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
    xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0
        http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0 http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0
        http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.1.0 http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.1.0
        http://karaf.apache.org/xmlns/shell/v1.1.0 http://karaf.apache.org/xmlns/shell/v1.1.0">

	<reference id="svcLookup" interface="org.soluvas.multitenant.ServiceLookup"/>

	<command-bundle xmlns="http://karaf.apache.org/xmlns/shell/v1.1.0">
		<command name="sec/rolels">
			<action class="org.soluvas.security.shell.SecRoleLsCommand">
				<argument ref="svcLookup" />
			</action>
		</command>
		<command name="sec/actionls">
			<action class="org.soluvas.security.shell.SecActionLsCommand">
				<argument ref="svcLookup" />
			</action>
		</command>
		<command name="sec/domainls">
			<action class="org.soluvas.security.shell.SecDomainLsCommand">
				<argument ref="svcLookup" />
			</action>
		</command>
		<command name="sec/permls">
			<action class="org.soluvas.security.shell.SecPermLsCommand">
				<argument ref="svcLookup" />
			</action>
		</command>
	</command-bundle>
	
	<bean class="org.soluvas.commons.EmfUnloader" destroy-method="destroy">
		<argument value="org.soluvas.security.SecurityPackage" />
	</bean>

	<bean id="defaultSecurityCatalogSupplier" class="org.soluvas.commons.XmiObjectLoader">
		<argument type="java.lang.Class" value="org.soluvas.security.SecurityPackage" />
		<argument value="org.soluvas.security.SecurityPackage" />
		<argument value="default.SecurityCatalog.xmi" />
	</bean>
	<service ref="defaultSecurityCatalogSupplier" auto-export="interfaces">
		<service-properties>
			<entry key="clientId" value="berbatik" />
			<entry key="tenantId" value="berbatik" />
			<entry key="tenantEnv" value="dev" />
			<entry key="suppliedClass" value="org.soluvas.security.SecurityCatalog" />
			<entry key="layer" value="module" />
		</service-properties>
	</service>
	
	<bean id="securityPackage" class="org.soluvas.security.impl.SecurityPackageImpl" factory-method="init" />
	<bean id="aggregatingSecurityCatalogSupplier" class="org.soluvas.commons.AggregatingSupplier">
		<argument>
			<bean class="org.soluvas.security.impl.SecurityFactoryImpl" />
		</argument>
		<argument>
			<bean factory-ref="securityPackage" factory-method="getSecurityCatalog" />
		</argument>
		<argument>
			<list>
<!-- 				<ref component-id="defaultSecurityCatalogSupplier"/> -->
<!-- 				<ref component-id="bippoSecurityCatalogSupplier"/> -->
			</list>
		</argument>
	</bean>
	<service ref="aggregatingSecurityCatalogSupplier" auto-export="interfaces">
		<service-properties>
			<entry key="clientId" value="berbatik" />
			<entry key="tenantId" value="berbatik" />
			<entry key="tenantEnv" value="dev" />
			<entry key="suppliedClass" value="org.soluvas.security.SecurityCatalog" />
			<entry key="layer" value="application" />
		</service-properties>
	</service>
	
	<bean id="securityCatalogSupplierTracker" class="org.soluvas.security.SecurityCatalogSupplierTracker">
		<argument ref="blueprintBundleContext" />
		<argument ref="aggregatingSecurityCatalogSupplier" />
	</bean>
	<bean class="org.osgi.util.tracker.ServiceTracker" init-method="open" destroy-method="close">
		<argument ref="blueprintBundleContext" />
		<argument>
			<bean class="org.osgi.framework.FrameworkUtil" factory-method="createFilter">
				<argument value="(&amp;(objectClass=com.google.common.base.Supplier)(suppliedClass=org.soluvas.security.SecurityCatalog)(tenantId=berbatik)(tenantEnv=dev)(layer=module))" />
			</bean>
		</argument>
		<argument ref="securityCatalogSupplierTracker" />
	</bean>
	
<!-- 	<bean id="securityCatalogXmiTracker" class="org.soluvas.security.SecurityCatalogXmiTracker"> -->
<!-- 		<argument ref="blueprintBundleContext" /> -->
<!-- 		<argument value="berbatik" /> -->
<!-- 		<argument value="dev" /> -->
<!-- 	</bean> -->
<!-- 	<bean class="org.osgi.util.tracker.BundleTracker" init-method="open" destroy-method="close"> -->
<!-- 		<argument ref="blueprintBundleContext" /> -->
<!-- 		<argument value="255" /> -->
<!-- 		<argument ref="securityCatalogXmiTracker" /> -->
<!-- 	</bean> -->

</blueprint>
